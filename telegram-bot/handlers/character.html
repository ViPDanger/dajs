<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</title>
  <script src="config.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f4f4f4; }
    label { display: block; margin-top: 1em; font-weight: bold; }
    input[type="text"], input[type="number"] {
      width: 100%; padding: 0.5em; font-size: 1em;
    }
    .attr-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
    }
    .skills-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px;
      font-size: 0.9em;
    }
    button {
      margin-top: 2em;
      padding: 0.7em;
      font-size: 1.1em;
      width: 100%;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h2>üßô –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>

  <label>–ò–º—è:</label>
  <input type="text" id="name">

  <label>–°—Ç–∞—Ç—É—Å:</label>
  <div class="attr-grid">
    <input id="hp" type="number" placeholder="HP">
    <input id="max_hp" type="number" placeholder="Max HP">
    <input id="temporary_hp" type="number" placeholder="Temp HP">
    <input id="armor_class" type="number" placeholder="AC">
    <input id="speed" type="number" placeholder="Speed">
    <input id="initiative" type="number" placeholder="Initiative">
  </div>

  <label>–ê—Ç—Ä–∏–±—É—Ç—ã:</label>
  <div class="attr-grid">
    <input id="strength" type="number" placeholder="Strength">
    <input id="dexterity" type="number" placeholder="Dexterity">
    <input id="constitution" type="number" placeholder="Constitution">
    <input id="intelligence" type="number" placeholder="Intelligence">
    <input id="wisdom" type="number" placeholder="Wisdom">
    <input id="charisma" type="number" placeholder="Charisma">
  </div>

  <label>–ù–∞–≤—ã–∫–∏ (–≤–ª–∞–¥–µ–Ω–∏–µ):</label>
  <div class="skills-grid" id="skills">
    <!-- –°–∫—Ä–∏–ø—Ç —Å–∞–º –¥–æ–±–∞–≤–∏—Ç -->
  </div>

  <button onclick="submit()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const urlParams = new URLSearchParams(window.location.search);
    const charId = urlParams.get("char_id");

    const skillNames = {
      acrobatics: "Acrobatics", animal_handling: "Animal Handling",
      arcana: "Arcana", athletics: "Athletics", deception: "Deception",
      history: "History", insight: "Insight", intimidation: "Intimidation",
      investigation: "Investigation", medicine: "Medicine", nature: "Nature",
      perception: "Perception", performance: "Performance", persuasion: "Persuasion",
      religion: "Religion", sleight_of_hand: "Sleight of Hand",
      stealth: "Stealth", survival: "Survival"
    };

    const skillContainer = document.getElementById("skills");
    for (const key in skillNames) {
      const div = document.createElement("div");
      div.innerHTML = `<label>
        <input type="checkbox" id="skill_${key}"> ${skillNames[key]}
      </label>`;
      skillContainer.appendChild(div);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    fetch(`/api/character/${charId}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById("name").value = data.name;

        const status = data.status || {};
        document.getElementById("hp").value = status.hp;
        document.getElementById("max_hp").value = status.max_hp;
        document.getElementById("temporary_hp").value = status.temporary_hp;
        document.getElementById("armor_class").value = status.armor_class;
        document.getElementById("speed").value = status.speed;
        document.getElementById("initiative").value = status.initiative;

        const attr = data.attributes || {};
        document.getElementById("strength").value = attr.strength;
        document.getElementById("dexterity").value = attr.dexterity;
        document.getElementById("constitution").value = attr.constitution;
        document.getElementById("intelligence").value = attr.intelligence;
        document.getElementById("wisdom").value = attr.wisdom;
        document.getElementById("charisma").value = attr.charisma;

        const skills = attr || {};
        for (const key in skillNames) {
          const skill = skills[key];
          if (skill?.proficient) {
            document.getElementById(`skill_${key}`).checked = true;
          }
        }
      });

    function submit() {
      const character = {
        name: document.getElementById("name").value,
        status: {
          hp: +document.getElementById("hp").value,
          max_hp: +document.getElementById("max_hp").value,
          temporary_hp: +document.getElementById("temporary_hp").value,
          armor_class: +document.getElementById("armor_class").value,
          speed: +document.getElementById("speed").value,
          initiative: +document.getElementById("initiative").value,
        },
        attributes: {
          strength: +document.getElementById("strength").value,
          dexterity: +document.getElementById("dexterity").value,
          constitution: +document.getElementById("constitution").value,
          intelligence: +document.getElementById("intelligence").value,
          wisdom: +document.getElementById("wisdom").value,
          charisma: +document.getElementById("charisma").value,
        },
      };

      // –î–æ–±–∞–≤–∏–º –Ω–∞–≤—ã–∫–∏
      for (const key in skillNames) {
        const proficient = document.getElementById(`skill_${key}`).checked;
        character.attributes[key] = {
          proficient: proficient,
          modifier: 0  // –º–æ–∂–µ—à—å –≤—ã—á–∏—Å–ª—è—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∞ –±—ç–∫–µ
        };
      }

      fetch(`${API_BASE_URL}${charId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(character)
      }).then(r => r.json())
        .then(resp => {
          tg.showAlert("–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");
          tg.close();
        });
    }
  </script>
</body>
</html>
